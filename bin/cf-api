#!/usr/bin/env bun
// Make an authenticated HTTP request to the Cloudflare API and print the response.
// Inspired by `gh api`.

import wretch from 'wretch'

const apiToken = process.env.CLOUDFLARE_API_TOKEN
const accountId = process.env.CLOUDFLARE_ACCOUNT_ID
const zoneId = process.env.CLOUDFLARE_ZONE_ID

const endpoint =
  Bun.argv[2]?.replace(/{account}|{account_id}/g, accountId)?.replace(/{zone}|{zone_id}/g, zoneId) || 'accounts'

wretch(`https://api.cloudflare.com/client/v4/${endpoint}`)
  .auth(`Bearer ${apiToken}`)
  .get()
  .json()
  .catch((error) => {
    const message =
      error.json?.errors?.map((e) => `${e.message} [code: ${e.code}]`).join('\n') ||
      `${error.message} [status: ${error.status}]`
    console.error(message)
    process.exit(1)
  })
  .then((data) => console.log(JSON.stringify(data.result, null, 2)))

// vim: ft=javascript
