#!/usr/bin/env ruby
# Jekyll preprocessor for Marked app
# Converts Jekyll posts to GitHub Markdown
# See http://brettterpstra.com/2013/01/04/previewing-jekyll-posts-with-marked/

begin
  Encoding.default_external = Encoding::UTF_8

  content = STDIN.read
  if content.start_with?("---")
    require "yaml"

    sections = content.split("---")
    frontmatter = YAML::load(sections[1])

    content = "# #{frontmatter["title"]}" + sections[2]
    content.gsub!(/\{% highlight (.*?) %\}/, "```\\1")
    content.gsub!(/\{% endhighlight %\}/, "```")
  end

  puts content
rescue => e
  puts "error = #{e.message}"
end
